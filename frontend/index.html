<!doctype html>
<html lang="zh" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å›¾ä¹¦é¦†ç®¡ç†ç³»ç»Ÿ</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            mint: {
              50: '#F6FFF8',
              100: '#E9FBEF',
              200: '#CFF5DC',
              300: '#AEECC4',
              400: '#7BC96F',
              500: '#4CAF50',
              600: '#2F8F46',
              700: '#1F6D36',
              800: '#164E2A',
              900: '#0F2F1B',
            }
          }
        }
      }
    }
  </script>

  <!-- Vue3 + Router + Axios -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.8/dist/axios.min.js"></script>

  <!-- Algolia -->
  <script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.23.3/dist/algoliasearch-lite.umd.js"></script>

  <style>
    .lift {
      transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
    }
    .lift:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,.08); }
    .lift:active { transform: translateY(0px) scale(0.99); filter: brightness(.98); }

    .glass {
      background: rgba(255,255,255,.7);
      backdrop-filter: blur(12px);
    }
    .dark .glass {
      background: rgba(17, 24, 39, .55);
    }
  </style>
</head>

<body class="h-full bg-mint-50 dark:bg-slate-950 text-slate-800 dark:text-slate-100">
<div id="app" class="min-h-full"></div>

<script>
/** =========================
 *  é…ç½®åŒºï¼šä½ åªè¦æ”¹è¿™é‡Œ
 *  ========================= */
const CONFIG = {
  API_BASE: "http://127.0.0.1:8000",
  ALGOLIA: {
    APP_ID: "9Q4KPXBNUL",            // å¡«ä½ çš„ Algolia App ID
    SEARCH_ONLY_KEY: "1f3cbccbdbf725fc68e4cb9d6192e797",   // å¡« Search-Only Keyï¼ˆå‰ç«¯å¯ç”¨ï¼‰
    INDEX: "book_index"
  }
};

/** =========================
 *  Axios å°è£…
 *  ========================= */
const api = axios.create({
  baseURL: CONFIG.API_BASE,
  timeout: 10000
});
api.interceptors.request.use((cfg) => {
  const token = localStorage.getItem("token");
  if (token) cfg.headers.Authorization = "Bearer " + token;
  return cfg;
});

/** =========================
 *  å°å·¥å…·ï¼šToast
 *  ========================= */
const ToastBus = Vue.reactive({ list: [] });
function toast(msg, type="info") {
  const id = Math.random().toString(16).slice(2);
  ToastBus.list.push({ id, msg, type });
  setTimeout(()=> {
    ToastBus.list = ToastBus.list.filter(x => x.id !== id);
  }, 2600);
}

/** =========================
 *  Auth Storeï¼ˆæç®€ï¼‰
 *  ========================= */
const Auth = Vue.reactive({
  username: localStorage.getItem("username") || "",
  role: localStorage.getItem("role") || "",
  reader_id: localStorage.getItem("reader_id") || "",
  token: localStorage.getItem("token") || "",
  isAuthed() { return !!this.token; },
  setAuth(t) {
    this.token = t.access_token;
    this.role = t.role;
    this.username = t.username;
    this.reader_id = t.reader_id ?? "";
    localStorage.setItem("token", this.token);
    localStorage.setItem("role", this.role);
    localStorage.setItem("username", this.username);
    localStorage.setItem("reader_id", this.reader_id);
  },
  logout() {
    this.username=""; this.role=""; this.reader_id=""; this.token="";
    localStorage.removeItem("token");
    localStorage.removeItem("role");
    localStorage.removeItem("username");
    localStorage.removeItem("reader_id");
  }
});

/** =========================
 *  Dark/Light Theme
 *  ========================= */
const Theme = Vue.reactive({
  dark: (localStorage.getItem("dark") === "1"),
  apply() {
    document.documentElement.classList.toggle("dark", this.dark);
    localStorage.setItem("dark", this.dark ? "1" : "0");
  }
});
Theme.apply();

/** =========================
 *  UI Components
 *  ========================= */
const AppShell = {
  template: `
  <div>
    <header class="sticky top-0 z-30 border-b border-mint-200/70 dark:border-slate-800 bg-white/70 dark:bg-slate-950/70 backdrop-blur">
      <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
        <div class="flex items-center gap-2">
          <div class="w-9 h-9 rounded-xl bg-mint-200 dark:bg-slate-800 flex items-center justify-center">ğŸ“š</div>
          <div>
            <div class="font-semibold leading-tight">å›¾ä¹¦é¦†ç®¡ç†ç³»ç»Ÿ</div>
            <div class="text-xs text-slate-500 dark:text-slate-400 leading-tight">
              {{ Auth.role ? (Auth.role==='reader'?'è¯»è€…ç«¯':'ç®¡ç†ç«¯') : 'æœªç™»å½•' }}
            </div>
          </div>
        </div>

        <div class="flex-1"></div>

        <SearchBar v-if="Auth.isAuthed()" />

        <button class="ml-2 px-3 py-2 rounded-xl lift border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"
          @click="toggleTheme">
          <span class="text-sm">{{ Theme.dark ? 'å¤œé—´' : 'ç™½å¤©' }}</span>
        </button>

        <template v-if="Auth.isAuthed()">
          <div class="ml-2 text-sm text-slate-600 dark:text-slate-300">
            {{ Auth.username }}
          </div>
          <button class="px-3 py-2 rounded-xl lift bg-mint-400 text-white hover:bg-mint-500"
            @click="doLogout">é€€å‡º</button>
        </template>
        <template v-else>
          <router-link class="px-3 py-2 rounded-xl lift bg-mint-400 text-white hover:bg-mint-500" to="/login">
            ç™»å½•
          </router-link>
        </template>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-6">
      <router-view />
    </main>

    <Toast />
  </div>
  `,
  setup() {
    const router = VueRouter.useRouter();
    return {
      Auth, Theme,
      toggleTheme() { Theme.dark = !Theme.dark; Theme.apply(); },
      doLogout() { Auth.logout(); toast("å·²é€€å‡º"); router.push("/login"); }
    };
  }
};

const Toast = {
  template: `
    <div class="fixed bottom-5 left-1/2 -translate-x-1/2 z-50 space-y-2">
      <div v-for="t in ToastBus.list" :key="t.id"
        class="px-4 py-3 rounded-2xl shadow-lg border text-sm glass border-mint-200 dark:border-slate-700">
        <span v-if="t.type==='ok'">âœ…</span>
        <span v-else-if="t.type==='err'">âš ï¸</span>
        <span v-else>ğŸ’¬</span>
        <span class="ml-2">{{ t.msg }}</span>
      </div>
    </div>
  `,
  setup(){ return { ToastBus }; }
};

const Card = {
  props: ["title", "desc"],
  template: `
    <div class="rounded-2xl border border-mint-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-5 shadow-sm">
      <div class="text-lg font-semibold">{{title}}</div>
      <div v-if="desc" class="text-sm text-slate-500 dark:text-slate-400 mt-1">{{desc}}</div>
      <div class="mt-4"><slot /></div>
    </div>
  `
};

const Btn = {
  props: ["label", "variant", "type"],
  template: `
    <button :type="type||'button'"
      class="lift px-4 py-2 rounded-xl text-sm font-medium"
      :class="variantClass">
      {{label}}<slot />
    </button>
  `,
  computed: {
    variantClass() {
      const v = this.variant || "primary";
      if (v === "primary") return "bg-mint-400 hover:bg-mint-500 text-white";
      if (v === "soft") return "bg-mint-100 dark:bg-slate-800 hover:bg-mint-200 dark:hover:bg-slate-700 text-slate-800 dark:text-slate-100 border border-mint-200 dark:border-slate-700";
      if (v === "danger") return "bg-rose-500 hover:bg-rose-600 text-white";
      return "bg-slate-200 hover:bg-slate-300 text-slate-800";
    }
  }
};

/** =========================
 *  SearchBar: Algolia autocomplete
 *  ========================= */
const SearchBar = {
  template: `
  <div class="relative w-[360px] max-w-[46vw]">
    <input v-model="q" @input="onInput" @focus="open=true" @blur="onBlur"
      placeholder="æœç´¢ä¹¦å / ISBN / åˆ†ç±»..."
      class="w-full px-4 py-2 rounded-2xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900 focus:outline-none focus:ring-2 focus:ring-mint-300"/>
    <div v-if="open && suggestions.length"
      class="absolute mt-2 w-full rounded-2xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-lg overflow-hidden">
      <div class="px-3 py-2 text-xs text-slate-500 dark:text-slate-400 border-b border-mint-100 dark:border-slate-800">
        å»ºè®®ï¼ˆç‚¹å‡»å¿«é€Ÿé€‰æ‹©ï¼‰
      </div>
      <button v-for="s in suggestions" :key="s.objectID"
        class="w-full text-left px-3 py-2 hover:bg-mint-100 dark:hover:bg-slate-800"
        @mousedown.prevent="selectSuggestion(s)">
        <div class="text-sm font-medium">{{ s.title }}</div>
        <div class="text-xs text-slate-500 dark:text-slate-400">
          {{ s.isbn || 'æ— ISBN' }} Â· {{ s.publisher_name || 'æœªçŸ¥å‡ºç‰ˆç¤¾' }} Â· å¯å€Ÿ {{ s.available_copies ?? '-' }}
        </div>
      </button>
      <div class="px-3 py-2 text-xs text-slate-500 dark:text-slate-400 border-t border-mint-100 dark:border-slate-800">
        å›è½¦ï¼šæŸ¥çœ‹æœç´¢ç»“æœ
      </div>
    </div>
  </div>
  `,
  setup() {
    const router = VueRouter.useRouter();
    const q = Vue.ref("");
    const open = Vue.ref(false);
    const suggestions = Vue.ref([]);

    let index = null;
    if (CONFIG.ALGOLIA.APP_ID && CONFIG.ALGOLIA.SEARCH_ONLY_KEY) {
      const client = algoliasearch(CONFIG.ALGOLIA.APP_ID, CONFIG.ALGOLIA.SEARCH_ONLY_KEY);
      index = client.initIndex(CONFIG.ALGOLIA.INDEX);
    }

    let tmr = null;
    async function onInput() {
      open.value = true;
      clearTimeout(tmr);
      tmr = setTimeout(async () => {
        if (!q.value.trim()) { suggestions.value = []; return; }
        if (!index) { suggestions.value = []; return; }
        try {
          const res = await index.search(q.value.trim(), { hitsPerPage: 6 });
          suggestions.value = res.hits || [];
        } catch (e) {
          suggestions.value = [];
        }
      }, 220);
    }

    function selectSuggestion(s) {
      open.value = false;
      q.value = "";
      router.push(`/books/${s.book_id || s.objectID}`);
    }

    function onBlur() {
      setTimeout(()=> open.value = false, 120);
    }

    // å›è½¦è·³è½¬æœç´¢é¡µ
    window.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && open.value && q.value.trim()) {
        router.push({ path: "/search", query: { q: q.value.trim() } });
        open.value = false;
        q.value = "";
      }
    });

    return { q, open, suggestions, onInput, onBlur, selectSuggestion };
  }
};

/** =========================
 *  Pages
 *  ========================= */

const LoginPage = {
  template: `
  <div class="grid md:grid-cols-2 gap-6">
    <Card title="ç™»å½•" desc="ç®¡ç†å‘˜/é¦†å‘˜/è¯»è€…ç™»å½•å…¥å£ï¼ˆé€‰æ‹©èº«ä»½ï¼‰">
      <form @submit.prevent="doLogin" class="space-y-3">
        <div>
          <div class="text-sm mb-1 text-slate-600 dark:text-slate-300">èº«ä»½</div>
          <select v-model="form.user_type"
            class="w-full px-4 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900">
            <option value="reader">è¯»è€…</option>
            <option value="staff">ç®¡ç†å‘˜/é¦†å‘˜</option>
          </select>
        </div>
        <div>
          <div class="text-sm mb-1 text-slate-600 dark:text-slate-300">ç”¨æˆ·å</div>
          <input v-model="form.username"
            class="w-full px-4 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900" />
        </div>
        <div>
          <div class="text-sm mb-1 text-slate-600 dark:text-slate-300">å¯†ç </div>
          <input type="password" v-model="form.password"
            class="w-full px-4 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900" />
        </div>

        <div class="flex items-center gap-2">
          <Btn label="ç™»å½•" variant="primary" type="submit" />
          <router-link class="text-sm text-mint-700 dark:text-mint-300 hover:underline" to="/register">
            æ³¨å†Œè¯»è€…è´¦å·
          </router-link>
        </div>
      </form>
    </Card>

    <Card title="è¯´æ˜" desc="è¯»è€…ç«¯ï¼šå€Ÿ/è¿˜/æŸ¥å€Ÿé˜…/æŸ¥ç½šæ¬¾/ç¼´è´¹ï¼›ç®¡ç†ç«¯ï¼šCRUD + ä»£åŠ">
      <div class="text-sm leading-relaxed text-slate-600 dark:text-slate-300">
        ç™»å½•æ—¶è¯·æ³¨æ„è§’è‰²çš„é€‰æ‹©ï¼Œå¦åˆ™å°†ç™»å½•å¤±è´¥<br/>
        å¦‚æœç”¨æˆ·å¿˜è®°å¯†ç è¯·è”ç³»ç®¡ç†å‘˜ä¿®æ”¹å¯†ç ã€‚
      </div>
    </Card>
  </div>
  `,
  components: { Card, Btn },
  setup() {
    const router = VueRouter.useRouter();
    const form = Vue.reactive({ user_type: "reader", username: "", password: "" });

    async function doLogin() {
      try {
        const res = await api.post("/api/auth/login", form);
        Auth.setAuth(res.data);
        toast("ç™»å½•æˆåŠŸ", "ok");
        router.push("/");
      } catch (e) {
        toast(e?.response?.data?.detail || "ç™»å½•å¤±è´¥", "err");
      }
    }
    return { form, doLogin };
  }
};

const RegisterPage = {
  template: `
  <div class="max-w-2xl mx-auto">
    <Card title="æ³¨å†Œè¯»è€…è´¦å·" desc="æ³¨å†Œåå¯ç™»å½•è¯»è€…ç«¯ï¼šå€Ÿé˜…/å½’è¿˜/ç½šæ¬¾æŸ¥è¯¢">
      <form @submit.prevent="doRegister" class="grid md:grid-cols-2 gap-3">
        <div class="md:col-span-2">
          <div class="text-sm mb-1 text-slate-600 dark:text-slate-300">ç”¨æˆ·å</div>
          <input v-model="form.username" class="w-full px-4 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/>
        </div>
        <div class="md:col-span-2">
          <div class="text-sm mb-1 text-slate-600 dark:text-slate-300">å¯†ç </div>
          <input type="password" v-model="form.password" class="w-full px-4 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/>
        </div>
        <div>
          <div class="text-sm mb-1 text-slate-600 dark:text-slate-300">è¯»è€…è¯å·/å­¦å·</div>
          <input v-model="form.reader_no" class="w-full px-4 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/>
        </div>
        <div>
          <div class="text-sm mb-1 text-slate-600 dark:text-slate-300">å§“å</div>
          <input v-model="form.name" class="w-full px-4 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/>
        </div>
        <div class="md:col-span-2">
          <div class="text-sm mb-1 text-slate-600 dark:text-slate-300">è¯»è€…ç±»åˆ«</div>
          <select v-model="form.category_id" class="w-full px-4 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900">
            <option disabled value="">è¯·é€‰æ‹©</option>
            <option v-for="c in cats" :key="c.category_id" :value="c.category_id">
              {{c.category_name}}ï¼ˆæœ€å¤šå€Ÿ{{c.max_borrow_count}}æœ¬ / {{c.max_borrow_days}}å¤© / è¶…æœŸ{{c.fine_per_day}}å…ƒ/å¤©ï¼‰
            </option>
          </select>
        </div>

        <div class="md:col-span-2 flex items-center gap-2 mt-2">
          <Btn label="æ³¨å†Œå¹¶ç™»å½•" variant="primary" type="submit" />
          <router-link class="text-sm text-mint-700 dark:text-mint-300 hover:underline" to="/login">è¿”å›ç™»å½•</router-link>
        </div>
      </form>
    </Card>
  </div>
  `,
  components: { Card, Btn },
  setup() {
    const router = VueRouter.useRouter();
    const form = Vue.reactive({ username:"", password:"", reader_no:"", name:"", category_id:"" });
    const cats = Vue.ref([]);

    Vue.onMounted(async () => {
      const res = await api.get("/api/reader-categories");
      cats.value = res.data;
    });

    async function doRegister() {
      try {
        const res = await api.post("/api/auth/register-reader", {
          ...form,
          category_id: Number(form.category_id)
        });
        Auth.setAuth(res.data);
        toast("æ³¨å†ŒæˆåŠŸ", "ok");
        router.push("/");
      } catch (e) {
        toast(e?.response?.data?.detail || "æ³¨å†Œå¤±è´¥", "err");
      }
    }

    return { form, cats, doRegister };
  }
};

const HomePage = {
  template: `
  <div class="grid lg:grid-cols-3 gap-6">
    <Card title="æ¬¢è¿" desc="å›¾ä¹¦é¦†ç®¡ç†ç³»ç»Ÿæ¬¢è¿æ‚¨">
      <div class="text-sm text-slate-600 dark:text-slate-300 leading-relaxed">
        ä½ å½“å‰èº«ä»½ï¼š<b>{{ Auth.role || 'æœªç™»å½•' }}</b><br/>
        è¯»è€…ç«¯ï¼šå€Ÿ/è¿˜/æŸ¥å€Ÿé˜…/æŸ¥ç½šæ¬¾/ç¼´è´¹<br/>
        ç®¡ç†ç«¯ï¼šç®¡ç†è¯»è€…/å‡ºç‰ˆç¤¾/å›¾ä¹¦/é¦†è— + ä»£åŠå€Ÿè¿˜
      </div>
      <div class="mt-4 flex flex-wrap gap-2">
        <router-link class="lift px-4 py-2 rounded-xl bg-mint-400 text-white hover:bg-mint-500" to="/books">æŸ¥ä¹¦</router-link>
        <router-link class="lift px-4 py-2 rounded-xl bg-mint-100 dark:bg-slate-800 border border-mint-200 dark:border-slate-700" to="/borrows">å€Ÿé˜…è®°å½•</router-link>
        <router-link class="lift px-4 py-2 rounded-xl bg-mint-100 dark:bg-slate-800 border border-mint-200 dark:border-slate-700" to="/fines">ç½šæ¬¾</router-link>
      </div>
    </Card>

    <Card v-if="Auth.role==='admin' || Auth.role==='librarian'" title="ç®¡ç†ç«¯å…¥å£" desc="åœ¨è¿™é‡Œè¿›è¡Œå„é¡¹ç®¡ç†">
      <div class="grid grid-cols-2 gap-2">
        <router-link class="lift px-4 py-2 rounded-xl bg-white dark:bg-slate-900 border border-mint-200 dark:border-slate-700" to="/admin/readers">è¯»è€…ç®¡ç†</router-link>
        <router-link class="lift px-4 py-2 rounded-xl bg-white dark:bg-slate-900 border border-mint-200 dark:border-slate-700" to="/admin/publishers">å‡ºç‰ˆç¤¾</router-link>
        <router-link class="lift px-4 py-2 rounded-xl bg-white dark:bg-slate-900 border border-mint-200 dark:border-slate-700" to="/admin/books">å›¾ä¹¦</router-link>
        <router-link class="lift px-4 py-2 rounded-xl bg-white dark:bg-slate-900 border border-mint-200 dark:border-slate-700" to="/admin/copies">é¦†è—</router-link>
      </div>
    </Card>

    <Card title="å€Ÿ/è¿˜å¿«æ·æ“ä½œ" desc="è¯»è€…å¯è‡ªå·±å€Ÿè¿˜ï¼›ç®¡ç†å‘˜ä¹Ÿå¯ä»£åŠ">
      <div class="space-y-3">
        <div>
          <div class="text-sm mb-1 text-slate-600 dark:text-slate-300">å€Ÿä¹¦ï¼šè¾“å…¥é¦†è— copy_id</div>
          <div class="flex gap-2">
            <input v-model="borrowCopyId" class="flex-1 px-4 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/>
            <Btn label="å€Ÿ" variant="primary" @click="doBorrow"/>
          </div>
        </div>
        <div>
          <div class="text-sm mb-1 text-slate-600 dark:text-slate-300">è¿˜ä¹¦ï¼šè¾“å…¥ borrow_id</div>
          <div class="flex gap-2">
            <input v-model="returnBorrowId" class="flex-1 px-4 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/>
            <Btn label="è¿˜" variant="soft" @click="doReturn"/>
          </div>
          <div class="mt-2 flex items-center gap-2 text-sm">
            <input id="dam" type="checkbox" v-model="isDamaged" class="accent-mint-500"/>
            <label for="dam" class="text-slate-600 dark:text-slate-300">æŸå</label>
            <input v-if="isDamaged" v-model="damageDesc" placeholder="æŸåæè¿°"
              class="flex-1 px-3 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/>
          </div>
        </div>
      </div>
    </Card>
  </div>
  `,
  components: { Card, Btn },
  setup() {
    const borrowCopyId = Vue.ref("");
    const returnBorrowId = Vue.ref("");
    const isDamaged = Vue.ref(false);
    const damageDesc = Vue.ref("");

    async function doBorrow() {
      if (!borrowCopyId.value) return toast("è¯·è¾“å…¥ copy_id", "err");
      try {
        await api.post("/api/borrow", { copy_id: Number(borrowCopyId.value) });
        toast("å€Ÿé˜…æˆåŠŸ", "ok");
        borrowCopyId.value = "";
      } catch (e) {
        toast(e?.response?.data?.detail || "å€Ÿé˜…å¤±è´¥", "err");
      }
    }
    async function doReturn() {
      if (!returnBorrowId.value) return toast("è¯·è¾“å…¥ borrow_id", "err");
      try {
        await api.post("/api/return", {
          borrow_id: Number(returnBorrowId.value),
          is_damaged: isDamaged.value,
          damage_desc: damageDesc.value || null
        });
        toast("å½’è¿˜æˆåŠŸï¼ˆå¦‚æœ‰è¶…æœŸ/æŸåä¼šè‡ªåŠ¨ç”Ÿæˆç½šæ¬¾ï¼‰", "ok");
        returnBorrowId.value = "";
        isDamaged.value = false;
        damageDesc.value = "";
      } catch (e) {
        toast(e?.response?.data?.detail || "å½’è¿˜å¤±è´¥", "err");
      }
    }

    return { Auth, borrowCopyId, returnBorrowId, isDamaged, damageDesc, doBorrow, doReturn };
  }
};

const BooksPage = {
  template: `
  <Card title="å›¾ä¹¦ç›®å½•" desc="è¯»è€…ä¹Ÿå¯è®¿é—®ï¼›ç®¡ç†ç«¯å¯æ–°å¢/ä¿®æ”¹/åˆ é™¤ï¼ˆåœ¨ç®¡ç†é¡µï¼‰">
    <div class="flex gap-2 mb-4">
      <input v-model="kw" placeholder="æœ¬åœ°è¿‡æ»¤ï¼šä¹¦å/ISBN"
        class="flex-1 px-4 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/>
      <Btn label="åˆ·æ–°" variant="soft" @click="load"/>
    </div>

    <div class="grid md:grid-cols-2 gap-3">
      <div v-for="b in filtered" :key="b.book_id"
        class="rounded-2xl border border-mint-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-4 lift">
        <div class="font-semibold">{{ b.title }}</div>
        <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">
          ISBNï¼š{{ b.isbn || 'æ— ' }} Â· {{ b.publisher_name || 'æœªçŸ¥å‡ºç‰ˆç¤¾' }} Â· å¯å€Ÿ {{ b.available_copies }} / æ€»æ•° {{ b.total_copies }}
        </div>
        <div class="mt-3 flex gap-2">
          <router-link class="px-3 py-2 rounded-xl bg-mint-100 dark:bg-slate-800 border border-mint-200 dark:border-slate-700 lift text-sm"
            :to="'/books/'+b.book_id">è¯¦æƒ…</router-link>
          <router-link class="px-3 py-2 rounded-xl bg-white dark:bg-slate-900 border border-mint-200 dark:border-slate-700 lift text-sm"
            :to="{ path:'/copies', query:{ book_id: b.book_id } }">çœ‹é¦†è—</router-link>
        </div>
      </div>
    </div>
  </Card>
  `,
  components: { Card, Btn },
  setup() {
    const kw = Vue.ref("");
    const list = Vue.ref([]);
    async function load() {
      const res = await api.get("/api/books");
      list.value = res.data;
    }
    Vue.onMounted(load);

    const filtered = Vue.computed(() => {
      const s = kw.value.trim().toLowerCase();
      if (!s) return list.value;
      return list.value.filter(x =>
        (x.title||"").toLowerCase().includes(s) ||
        (x.isbn||"").toLowerCase().includes(s)
      );
    });

    return { kw, list, filtered, load };
  }
};

const BookDetailPage = {
  template: `
  <div v-if="book">
    <Card :title="book.title" :desc="'å¯å€Ÿ ' + book.available_copies + ' / æ€»æ•° ' + book.total_copies">
      <div class="grid md:grid-cols-2 gap-3 text-sm text-slate-600 dark:text-slate-300">
        <div>ISBNï¼š{{ book.isbn || 'æ— ' }}</div>
        <div>åˆ†ç±»ï¼š{{ book.category || 'æœªåˆ†ç±»' }}</div>
        <div>è¯­è¨€ï¼š{{ book.language || '-' }}</div>
        <div>ä»·æ ¼ï¼š{{ book.price ?? '-' }}</div>
        <div>å‡ºç‰ˆç¤¾ï¼š{{ book.publisher_name || 'æœªçŸ¥å‡ºç‰ˆç¤¾' }}</div>
      </div>
      <div class="mt-4 text-sm text-slate-600 dark:text-slate-300 leading-relaxed">
        ç®€ä»‹ï¼š{{ book.summary || 'æš‚æ— ç®€ä»‹' }}
      </div>
      <div class="mt-4">
        <router-link class="lift px-4 py-2 rounded-xl bg-mint-100 dark:bg-slate-800 border border-mint-200 dark:border-slate-700"
          :to="{ path:'/copies', query:{ book_id: book.book_id } }">æŸ¥çœ‹é¦†è—</router-link>
      </div>
    </Card>
  </div>
  `,
  components: { Card },
  setup() {
    const route = VueRouter.useRoute();
    const book = Vue.ref(null);
    Vue.onMounted(async () => {
      const res = await api.get("/api/books");
      const id = Number(route.params.id);
      book.value = res.data.find(x => x.book_id === id) || null;
      if (!book.value) toast("æ‰¾ä¸åˆ°è¯¥ä¹¦", "err");
    });
    return { book };
  }
};

const CopiesPage = {
  template: `
  <Card title="é¦†è—åˆ—è¡¨" desc="æ˜¾ç¤ºæ¯ä¸€å†Œï¼ˆcopy_id / barcode / çŠ¶æ€ï¼‰ã€‚è¯»è€…å€Ÿä¹¦è¦ç”¨ copy_id">
    <div class="flex gap-2 mb-4">
      <input v-model="bookId" placeholder="book_idï¼ˆå¯é€‰ï¼‰"
        class="w-44 px-4 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/>
      <Btn label="æŸ¥è¯¢" variant="soft" @click="load"/>
      <div class="flex-1"></div>
      <div class="text-sm text-slate-500 dark:text-slate-400">å€Ÿä¹¦å¿«æ·ï¼šå›åˆ°é¦–é¡µè¾“å…¥ copy_id</div>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left text-slate-500 dark:text-slate-400 border-b border-mint-200 dark:border-slate-800">
            <th class="py-2">copy_id</th>
            <th>book_id</th>
            <th>barcode</th>
            <th>location</th>
            <th>status</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="c in list" :key="c.copy_id" class="border-b border-mint-100 dark:border-slate-900">
            <td class="py-2 font-medium">{{c.copy_id}}</td>
            <td>{{c.book_id}}</td>
            <td>{{c.barcode}}</td>
            <td>{{c.location || '-'}}</td>
            <td>
              <span class="px-2 py-1 rounded-lg text-xs"
                :class="c.status==='available' ? 'bg-mint-100 text-mint-800 dark:bg-slate-800 dark:text-mint-200' :
                        c.status==='borrowed' ? 'bg-amber-100 text-amber-800 dark:bg-slate-800 dark:text-amber-200' :
                        'bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-200'">
                {{c.status}}
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </Card>
  `,
  components: { Card, Btn },
  setup() {
    const route = VueRouter.useRoute();
    const bookId = Vue.ref(route.query.book_id || "");
    const list = Vue.ref([]);

    async function load() {
      const params = {};
      if (bookId.value) params.book_id = Number(bookId.value);
      const res = await api.get("/api/copies", { params });
      list.value = res.data;
    }
    Vue.onMounted(load);
    return { bookId, list, load };
  }
};

const BorrowsPage = {
  template: `
  <Card title="å€Ÿé˜…è®°å½•" desc="è¯»è€…åªçœ‹è‡ªå·±çš„ï¼›ç®¡ç†å‘˜å¯çœ‹å…¨éƒ¨ï¼ˆè¿™é‡Œç»™äº†å…¨é‡å±•ç¤ºï¼Œä½ ä¹Ÿå¯åŠ ç­›é€‰ï¼‰">
    <div class="flex gap-2 mb-4">
      <select v-model="status" class="px-4 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900">
        <option value="">å…¨éƒ¨</option>
        <option value="borrowed">å€Ÿå‡ºä¸­</option>
        <option value="returned">å·²å½’è¿˜</option>
        <option value="overdue_returned">è¶…æœŸå½’è¿˜</option>
        <option value="damaged_returned">æŸåå½’è¿˜</option>
      </select>
      <Btn label="åˆ·æ–°" variant="soft" @click="load"/>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left text-slate-500 dark:text-slate-400 border-b border-mint-200 dark:border-slate-800">
            <th class="py-2">borrow_id</th>
            <th>reader_id</th>
            <th>copy_id</th>
            <th>due</th>
            <th>return</th>
            <th>status</th>
            <th>fine</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="b in list" :key="b.borrow_id" class="border-b border-mint-100 dark:border-slate-900">
            <td class="py-2 font-medium">{{b.borrow_id}}</td>
            <td>{{b.reader_id}}</td>
            <td>{{b.copy_id}}</td>
            <td>{{fmt(b.due_time)}}</td>
            <td>{{b.return_time ? fmt(b.return_time) : '-'}}</td>
            <td>{{b.status}}</td>
            <td>
              <span v-if="b.fine_amount>0" class="text-rose-600 dark:text-rose-300">
                {{b.fine_amount}} ({{b.fine_status}})
              </span>
              <span v-else>-</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </Card>
  `,
  components: { Card, Btn },
  setup() {
    const list = Vue.ref([]);
    const status = Vue.ref("");

    function fmt(s) {
      const d = new Date(s);
      return d.toLocaleString();
    }

    async function load() {
      const res = await api.get("/api/borrows", { params: status.value ? { status: status.value } : {} });
      list.value = res.data;
    }
    Vue.onMounted(load);
    return { list, status, load, fmt };
  }
};

const FinesPage = {
  template: `
  <Card title="ç½šæ¬¾ä¸ç¼´è´¹" desc="è¯»è€…åªçœ‹è‡ªå·±çš„ç½šæ¬¾ï¼›å¯ç›´æ¥ç¼´è´¹ï¼ˆå†™å…¥ç¼´è´¹è®°å½•å¹¶æ›´æ–°ä½™é¢ï¼‰">
    <div class="flex gap-2 mb-4">
      <select v-model="status" class="px-4 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900">
        <option value="">å…¨éƒ¨</option>
        <option value="unpaid">æœªç¼´</option>
        <option value="paid">å·²ç¼´</option>
      </select>
      <Btn label="åˆ·æ–°" variant="soft" @click="load"/>
      <div class="flex-1"></div>
      <div class="text-sm text-slate-500 dark:text-slate-400">
        è¯´æ˜ï¼šå½’è¿˜æ—¶è‹¥è¶…æœŸ/æŸåä¼šè‡ªåŠ¨ç”Ÿæˆç½šæ¬¾
      </div>
    </div>

    <div class="space-y-3">
      <div v-for="f in list" :key="f.fine_id"
        class="rounded-2xl border border-mint-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-4">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 rounded-xl bg-mint-100 dark:bg-slate-800 flex items-center justify-center">ğŸ’¸</div>
          <div class="flex-1">
            <div class="font-semibold">
              fine_id={{f.fine_id}} Â· {{f.reason}} Â· ï¿¥{{f.amount}}
              <span class="ml-2 text-xs px-2 py-1 rounded-lg"
                :class="f.status==='unpaid' ? 'bg-rose-100 text-rose-700 dark:bg-slate-800 dark:text-rose-200' :
                        'bg-mint-100 text-mint-800 dark:bg-slate-800 dark:text-mint-200'">
                {{f.status}}
              </span>
            </div>
            <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">
              created: {{fmt(f.created_at)}} Â· paid: {{f.paid_at ? fmt(f.paid_at) : '-'}} Â· borrow_id: {{f.borrow_id || '-'}}
            </div>
          </div>

          <div v-if="f.status==='unpaid'" class="flex items-center gap-2">
            <select v-model="payMethod[f.fine_id]"
              class="px-3 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm">
              <option value="cash">ç°é‡‘</option>
              <option value="wechat">å¾®ä¿¡</option>
              <option value="alipay">æ”¯ä»˜å®</option>
              <option value="card">åˆ·å¡</option>
              <option value="other">å…¶ä»–</option>
            </select>
            <Btn label="ç¼´è´¹" variant="primary" @click="pay(f.fine_id)"/>
          </div>
        </div>
      </div>
    </div>
  </Card>
  `,
  components: { Card, Btn },
  setup() {
    const list = Vue.ref([]);
    const status = Vue.ref("");
    const payMethod = Vue.reactive({});

    function fmt(s) { return new Date(s).toLocaleString(); }

    async function load() {
      const res = await api.get("/api/fines", { params: status.value ? { status: status.value } : {} });
      list.value = res.data;
      for (const f of list.value) payMethod[f.fine_id] ||= "cash";
    }

    async function pay(fine_id) {
      try {
        await api.post(`/api/fines/${fine_id}/pay`, { method: payMethod[fine_id] });
        toast("ç¼´è´¹æˆåŠŸ", "ok");
        await load();
      } catch (e) {
        toast(e?.response?.data?.detail || "ç¼´è´¹å¤±è´¥", "err");
      }
    }

    Vue.onMounted(load);
    return { list, status, load, fmt, payMethod, pay };
  }
};

/** ======= Admin CRUD Pagesï¼ˆç®€åŒ–ç‰ˆï¼‰ ======= */

function guardAdmin() {
  if (!(Auth.role === "admin" || Auth.role === "librarian")) {
    toast("æ— æƒé™è®¿é—®ç®¡ç†ç«¯", "err");
    return false;
  }
  return true;
}

const AdminReaders = {
  template: `
  <Card title="è¯»è€…ç®¡ç†" desc="ç®¡ç†å‘˜/é¦†å‘˜ï¼šä¿®æ”¹è¯»è€…ä¿¡æ¯ï¼ˆåˆ é™¤ä»…adminï¼‰">
    <div class="flex gap-2 mb-4">
      <Btn label="åˆ·æ–°" variant="soft" @click="load"/>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left text-slate-500 dark:text-slate-400 border-b border-mint-200 dark:border-slate-800">
            <th class="py-2">reader_id</th><th>reader_no</th><th>name</th><th>status</th><th>borrowed</th><th>fine</th><th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="r in list" :key="r.reader_id" class="border-b border-mint-100 dark:border-slate-900">
            <td class="py-2 font-medium">{{r.reader_id}}</td>
            <td>{{r.reader_no}}</td>
            <td><input v-model="r.name" class="px-2 py-1 rounded-lg border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/></td>
            <td>
              <select v-model="r.status" class="px-2 py-1 rounded-lg border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900">
                <option value="active">active</option>
                <option value="blocked">blocked</option>
              </select>
            </td>
            <td>{{r.borrowed_count}}</td>
            <td>{{r.fine_balance}}</td>
            <td class="space-x-2">
              <button class="lift px-3 py-1 rounded-lg bg-mint-400 hover:bg-mint-500 text-white" @click="save(r)">ä¿å­˜</button>
              <button v-if="Auth.role==='admin'" class="lift px-3 py-1 rounded-lg bg-rose-500 hover:bg-rose-600 text-white" @click="del(r.reader_id)">åˆ é™¤</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </Card>
  `,
  components: { Card },
  setup() {
    const router = VueRouter.useRouter();
    const list = Vue.ref([]);
    Vue.onMounted(async ()=>{
      if (!guardAdmin()) return router.push("/");
      await load();
    });

    async function load() {
      const res = await api.get("/api/readers");
      list.value = res.data;
    }
    async function save(r) {
      try {
        await api.put(`/api/readers/${r.reader_id}`, { name: r.name, status: r.status });
        toast("ä¿å­˜æˆåŠŸ", "ok");
      } catch (e) {
        toast(e?.response?.data?.detail || "ä¿å­˜å¤±è´¥", "err");
      }
    }
    async function del(id) {
      if (!confirm("ç¡®å®šåˆ é™¤è¯¥è¯»è€…å—ï¼Ÿ")) return;
      try {
        await api.delete(`/api/readers/${id}`);
        toast("åˆ é™¤æˆåŠŸ", "ok");
        await load();
      } catch (e) {
        toast(e?.response?.data?.detail || "åˆ é™¤å¤±è´¥", "err");
      }
    }

    return { list, load, save, del, Auth };
  }
};

const AdminPublishers = {
  template: `
  <Card title="å‡ºç‰ˆç¤¾ç®¡ç†" desc="æ–°å¢/ä¿®æ”¹/åˆ é™¤">
    <div class="flex gap-2 mb-4">
      <input v-model="newName" placeholder="æ–°å¢å‡ºç‰ˆç¤¾åç§°"
        class="flex-1 px-4 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/>
      <Btn label="æ–°å¢" variant="primary" @click="add"/>
      <Btn label="åˆ·æ–°" variant="soft" @click="load"/>
    </div>
    <div class="space-y-2">
      <div v-for="p in list" :key="p.publisher_id"
        class="flex items-center gap-2 rounded-2xl border border-mint-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-3">
        <div class="w-16 text-xs text-slate-500">#{{p.publisher_id}}</div>
        <input v-model="p.name" class="flex-1 px-3 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/>
        <button class="lift px-3 py-2 rounded-xl bg-mint-400 hover:bg-mint-500 text-white text-sm" @click="save(p)">ä¿å­˜</button>
        <button class="lift px-3 py-2 rounded-xl bg-rose-500 hover:bg-rose-600 text-white text-sm" @click="del(p.publisher_id)">åˆ é™¤</button>
      </div>
    </div>
  </Card>
  `,
  components: { Card, Btn },
  setup() {
    const router = VueRouter.useRouter();
    const list = Vue.ref([]);
    const newName = Vue.ref("");

    Vue.onMounted(async ()=>{
      if (!guardAdmin()) return router.push("/");
      await load();
    });

    async function load() {
      const res = await api.get("/api/publishers");
      list.value = res.data;
    }
    async function add() {
      if (!newName.value.trim()) return toast("è¯·è¾“å…¥å‡ºç‰ˆç¤¾åç§°", "err");
      try {
        await api.post("/api/publishers", { name: newName.value.trim() });
        toast("æ–°å¢æˆåŠŸ", "ok");
        newName.value = "";
        await load();
      } catch(e) {
        toast(e?.response?.data?.detail || "æ–°å¢å¤±è´¥", "err");
      }
    }
    async function save(p) {
      try {
        await api.put(`/api/publishers/${p.publisher_id}`, { name: p.name, contact: p.contact||null, phone: p.phone||null, address: p.address||null });
        toast("ä¿å­˜æˆåŠŸ", "ok");
      } catch(e) {
        toast(e?.response?.data?.detail || "ä¿å­˜å¤±è´¥", "err");
      }
    }
    async function del(id) {
      if (!confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) return;
      try {
        await api.delete(`/api/publishers/${id}`);
        toast("åˆ é™¤æˆåŠŸ", "ok");
        await load();
      } catch(e) {
        toast(e?.response?.data?.detail || "åˆ é™¤å¤±è´¥", "err");
      }
    }

    return { list, newName, load, add, save, del };
  }
};

const AdminBooks = {
  template: `
  <Card title="å›¾ä¹¦ç®¡ç†" desc="æ–°å¢/ä¿®æ”¹/åˆ é™¤ï¼ˆä¼šå°è¯•åŒæ­¥ Algoliaï¼‰">
    <div class="grid md:grid-cols-4 gap-2 mb-4">
      <input v-model="form.title" placeholder="ä¹¦å*"
        class="md:col-span-2 px-4 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/>
      <input v-model="form.isbn" placeholder="ISBN"
        class="px-4 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/>
      <input v-model="form.category" placeholder="åˆ†ç±»"
        class="px-4 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/>
      <div class="md:col-span-4 flex gap-2">
        <Btn label="æ–°å¢å›¾ä¹¦" variant="primary" @click="add"/>
        <Btn label="åˆ·æ–°" variant="soft" @click="load"/>
      </div>
    </div>

    <div class="space-y-2">
      <div v-for="b in list" :key="b.book_id"
        class="rounded-2xl border border-mint-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-4">
        <div class="flex gap-2 items-center">
          <div class="text-xs text-slate-500 w-20">#{{b.book_id}}</div>
          <input v-model="b.title" class="flex-1 px-3 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/>
          <input v-model="b.isbn" class="w-48 px-3 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/>
        </div>
        <div class="mt-2 flex gap-2 items-center">
          <input v-model="b.category" placeholder="åˆ†ç±»" class="flex-1 px-3 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/>
          <div class="text-xs text-slate-500">å¯å€Ÿ {{b.available_copies}} / æ€» {{b.total_copies}}</div>
          <button class="lift px-3 py-2 rounded-xl bg-mint-400 hover:bg-mint-500 text-white text-sm" @click="save(b)">ä¿å­˜</button>
          <button class="lift px-3 py-2 rounded-xl bg-rose-500 hover:bg-rose-600 text-white text-sm" @click="del(b.book_id)">åˆ é™¤</button>
        </div>
      </div>
    </div>
  </Card>
  `,
  components: { Card, Btn },
  setup() {
    const router = VueRouter.useRouter();
    const list = Vue.ref([]);
    const form = Vue.reactive({ title:"", isbn:"", category:"" });

    Vue.onMounted(async ()=>{
      if (!guardAdmin()) return router.push("/");
      await load();
    });

    async function load() {
      const res = await api.get("/api/books");
      list.value = res.data;
    }
    async function add() {
      if (!form.title.trim()) return toast("ä¹¦åå¿…å¡«", "err");
      try {
        await api.post("/api/books", { title: form.title.trim(), isbn: form.isbn.trim()||null, category: form.category.trim()||null });
        toast("æ–°å¢æˆåŠŸ", "ok");
        form.title=""; form.isbn=""; form.category="";
        await load();
      } catch(e) {
        toast(e?.response?.data?.detail || "æ–°å¢å¤±è´¥", "err");
      }
    }
    async function save(b) {
      try {
        await api.put(`/api/books/${b.book_id}`, { title: b.title, isbn: b.isbn||null, category: b.category||null });
        toast("ä¿å­˜æˆåŠŸ", "ok");
      } catch(e) {
        toast(e?.response?.data?.detail || "ä¿å­˜å¤±è´¥", "err");
      }
    }
    async function del(id) {
      if (!confirm("ç¡®å®šåˆ é™¤è¯¥å›¾ä¹¦å—ï¼Ÿï¼ˆéœ€å…ˆåˆ é¦†è—ï¼‰")) return;
      try {
        await api.delete(`/api/books/${id}`);
        toast("åˆ é™¤æˆåŠŸ", "ok");
        await load();
      } catch(e) {
        toast(e?.response?.data?.detail || "åˆ é™¤å¤±è´¥", "err");
      }
    }

    return { list, form, load, add, save, del };
  }
};

const AdminCopies = {
  template: `
  <Card title="é¦†è—ç®¡ç†" desc="æ–°å¢é¦†è—ä¼šè‡ªåŠ¨æ›´æ–°å›¾ä¹¦åº“å­˜ï¼›åˆ é™¤ä»…admin">
    <div class="grid md:grid-cols-4 gap-2 mb-4">
      <input v-model="form.book_id" placeholder="book_id*"
        class="px-4 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/>
      <input v-model="form.barcode" placeholder="barcode*ï¼ˆå”¯ä¸€ï¼‰"
        class="md:col-span-2 px-4 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/>
      <input v-model="form.location" placeholder="location"
        class="px-4 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/>
      <div class="md:col-span-4 flex gap-2">
        <Btn label="æ–°å¢é¦†è—" variant="primary" @click="add"/>
        <Btn label="åˆ·æ–°" variant="soft" @click="load"/>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left text-slate-500 dark:text-slate-400 border-b border-mint-200 dark:border-slate-800">
            <th class="py-2">copy_id</th><th>book_id</th><th>barcode</th><th>location</th><th>status</th><th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="c in list" :key="c.copy_id" class="border-b border-mint-100 dark:border-slate-900">
            <td class="py-2 font-medium">{{c.copy_id}}</td>
            <td>{{c.book_id}}</td>
            <td>{{c.barcode}}</td>
            <td><input v-model="c.location" class="px-2 py-1 rounded-lg border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/></td>
            <td>
              <select v-model="c.status" class="px-2 py-1 rounded-lg border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900">
                <option value="available">available</option>
                <option value="borrowed">borrowed</option>
                <option value="lost">lost</option>
                <option value="repair">repair</option>
              </select>
            </td>
            <td class="space-x-2">
              <button class="lift px-3 py-1 rounded-lg bg-mint-400 hover:bg-mint-500 text-white" @click="save(c)">ä¿å­˜</button>
              <button v-if="Auth.role==='admin'" class="lift px-3 py-1 rounded-lg bg-rose-500 hover:bg-rose-600 text-white" @click="del(c.copy_id)">åˆ é™¤</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </Card>
  `,
  components: { Card, Btn },
  setup() {
    const router = VueRouter.useRouter();
    const list = Vue.ref([]);
    const form = Vue.reactive({ book_id:"", barcode:"", location:"" });

    Vue.onMounted(async ()=>{
      if (!guardAdmin()) return router.push("/");
      await load();
    });

    async function load() {
      const res = await api.get("/api/copies");
      list.value = res.data;
    }
    async function add() {
      if (!form.book_id || !form.barcode.trim()) return toast("book_id å’Œ barcode å¿…å¡«", "err");
      try {
        await api.post("/api/copies", {
          book_id: Number(form.book_id),
          barcode: form.barcode.trim(),
          location: form.location.trim() || null,
          status: "available"
        });
        toast("æ–°å¢æˆåŠŸ", "ok");
        form.book_id=""; form.barcode=""; form.location="";
        await load();
      } catch(e) {
        toast(e?.response?.data?.detail || "æ–°å¢å¤±è´¥", "err");
      }
    }
    async function save(c) {
      try {
        await api.put(`/api/copies/${c.copy_id}`, {
          book_id: c.book_id,
          barcode: c.barcode,
          location: c.location || null,
          status: c.status
        });
        toast("ä¿å­˜æˆåŠŸ", "ok");
      } catch(e) {
        toast(e?.response?.data?.detail || "ä¿å­˜å¤±è´¥", "err");
      }
    }
    async function del(id) {
      if (!confirm("ç¡®å®šåˆ é™¤è¯¥é¦†è—å—ï¼Ÿ")) return;
      try {
        await api.delete(`/api/copies/${id}`);
        toast("åˆ é™¤æˆåŠŸ", "ok");
        await load();
      } catch(e) {
        toast(e?.response?.data?.detail || "åˆ é™¤å¤±è´¥", "err");
      }
    }

    return { list, form, load, add, save, del, Auth };
  }
};

const SearchPage = {
  template: `
  <Card title="æœç´¢ç»“æœ" desc="ä½¿ç”¨ Algolia æœç´¢ï¼ˆè‹¥æ²¡é…ç½® Algoliaï¼Œä¼šæç¤ºï¼‰">
    <div class="flex gap-2 mb-4">
      <input v-model="q" placeholder="è¾“å…¥å…³é”®è¯..."
        class="flex-1 px-4 py-2 rounded-xl border border-mint-200 dark:border-slate-700 bg-white dark:bg-slate-900"/>
      <Btn label="æœç´¢" variant="primary" @click="searchNow"/>
    </div>

    <div v-if="!algoliaOk" class="text-sm text-amber-700 dark:text-amber-200 bg-amber-100 dark:bg-slate-800 border border-amber-200 dark:border-slate-700 rounded-2xl p-4">
      ä½ è¿˜æ²¡é…ç½® Algoliaï¼ˆCONFIG.ALGOLIAï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œåªèƒ½ç”¨æœ¬åœ° /books é¡µé¢æŸ¥çœ‹ã€‚
    </div>

    <div class="grid md:grid-cols-2 gap-3 mt-4">
      <div v-for="h in hits" :key="h.objectID"
        class="rounded-2xl border border-mint-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-4 lift">
        <div class="font-semibold">{{h.title}}</div>
        <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">
          {{h.isbn || 'æ— ISBN'}} Â· {{h.publisher_name || 'æœªçŸ¥å‡ºç‰ˆç¤¾'}} Â· å¯å€Ÿ {{h.available_copies ?? '-'}}
        </div>
        <div class="mt-3">
          <router-link class="lift px-4 py-2 rounded-xl bg-mint-100 dark:bg-slate-800 border border-mint-200 dark:border-slate-700"
            :to="'/books/'+(h.book_id||h.objectID)">æŸ¥çœ‹è¯¦æƒ…</router-link>
        </div>
      </div>
    </div>
  </Card>
  `,
  components: { Card, Btn },
  setup() {
    const route = VueRouter.useRoute();
    const router = VueRouter.useRouter();

    const q = Vue.ref((route.query.q || "").toString());
    const hits = Vue.ref([]);

    const algoliaOk = !!(CONFIG.ALGOLIA.APP_ID && CONFIG.ALGOLIA.SEARCH_ONLY_KEY && CONFIG.ALGOLIA.INDEX);
    let index = null;
    if (algoliaOk) {
      const client = algoliasearch(CONFIG.ALGOLIA.APP_ID, CONFIG.ALGOLIA.SEARCH_ONLY_KEY);
      index = client.initIndex(CONFIG.ALGOLIA.INDEX);
    }

    // ç®€æ˜“ debounce
    function debounce(fn, ms = 250) {
      let t = null;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), ms);
      };
    }

    async function doSearch(keyword) {
      const s = (keyword || "").trim();
      if (!index) return;
      if (!s) {
        hits.value = [];
        return;
      }
      // ä½ å¯ä»¥æ”¹æˆ >=2 æ‰è§¦å‘ï¼Œå‡å°‘è¯·æ±‚
      // if (s.length < 2) { hits.value = []; return; }

      const res = await index.search(s, { hitsPerPage: 12 });
      hits.value = res.hits || [];
    }

    const debouncedSearch = debounce(doSearch, 250);

    // è¾“å…¥å³æœï¼šqå˜åŒ– -> æ›´æ–°URL -> debouncedSearch
    Vue.watch(q, (val) => {
      router.replace({ query: { ...route.query, q: val || "" } });
      debouncedSearch(val);
    });

    // ç‚¹å‡»æŒ‰é’®ï¼šç«‹åˆ»æœï¼ˆä¸ç­‰ debounceï¼‰
    async function searchNow() {
      await doSearch(q.value);
    }

    Vue.onMounted(() => {
      if (q.value && index) doSearch(q.value);
    });

    return { q, hits, algoliaOk, searchNow };
  }
};

/** =========================
 *  Router
 *  ========================= */
const routes = [
  { path: "/", component: HomePage },
  { path: "/login", component: LoginPage },
  { path: "/register", component: RegisterPage },

  { path: "/books", component: BooksPage },
  { path: "/books/:id", component: BookDetailPage },
  { path: "/copies", component: CopiesPage },
  { path: "/borrows", component: BorrowsPage },
  { path: "/fines", component: FinesPage },
  { path: "/search", component: SearchPage },

  { path: "/admin/readers", component: AdminReaders },
  { path: "/admin/publishers", component: AdminPublishers },
  { path: "/admin/books", component: AdminBooks },
  { path: "/admin/copies", component: AdminCopies },
];

const router = VueRouter.createRouter({
  history: VueRouter.createWebHashHistory(),
  routes
});

router.beforeEach((to) => {
  const publicPages = ["/login", "/register"];
  if (!Auth.isAuthed() && !publicPages.includes(to.path)) {
    toast("è¯·å…ˆç™»å½•", "err");
    return "/login";
  }
});

/** =========================
 *  App Mount
 *  ========================= */
const app = Vue.createApp(AppShell);
app.component("Toast", Toast);
app.component("SearchBar", SearchBar);
app.use(router);
app.mount("#app");
</script>
</body>
</html>
